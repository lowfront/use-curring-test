# useCurring 함수 메모이제이션 테스트

기존 [useCurring](https://github.com/ridi/ridi/blob/master/frontends/app/books-mobile/src/hooks/contentsHome/useCurring.tsx) 함수에서 메모이제이션이 작동하지 않아서 기존 요구사항을 최대한 반영하면서 메모이제이션이 적용되는 `useCurring` 훅을 만들기 위한 예제 프로젝트. React 테스트는 [React Developer Tools](https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi?hl=ko)의 `Highlight updates when components render` 기능을 활용해서 리렌더링 컴포넌트를 확인하고, ReactNative 테스트는 앱 실행 후 상단 `useCurring` 탭에서 각각의 훅이 사용된 컴포넌트 리렌더링 여부 확인.

## 기능요구
1. React 앱 최적화를 위해 생성되는 함수들은 메모이제이션 되어야 함
2. 파라미터만 다른 같은 함수를 useCallback으로 래핑해서 매번 새로 만드는 불편을 해소하고, 컴포넌트의 이벤트 핸들에 직접 파라미터를 입력해 호출해서 파라미터가 고정된 핸들을 생성
3. 핸들을 생성하는 함수도 prop을 통해서 전달해서 컴포넌트 내부에서 사용 가능
4. 핸들을 생성하기 위한 파라미터가 변경되더라도 문제없이 작동

## 기존 hook 문제점
- 2번 요구사항 처리과정에서 핸들 생성시 매번 새로운 핸들 함수가 prop으로 전달되어 리렌더링 유발
- 3번 요구사항의 경우 훅을 넘길때는 메모이제이션이 작동하지만 결국 사용하기 위해 핸들을 생성해야하는데 핸들을 생성하는 경우 새로운 핸들함수가 prop으로 전달되어 리렌더링을 유발
## 해결 방법
- 리렌더링을 방지하기 위해 핸들을 생성하기 위한 함수와 핸들함수를 모두 필요한 만큼만 생성하고 같은 객체를 재활용해서 사용
- 사용되는 핸들의 개수는 컴포넌트 렌더링시 결정 되는 것을 이용해서 핸들 생성함수가 호출된 순서를 인덱스로 활용하여 사용해야하는 파라미터를 결정하는 함수를 저장하고 재활용(리렌더링 방지)
- 핸들에 동적 파라미터를 허용하기 위해, 리렌더링시 저장된 인덱스를 0으로 수정하여 파라미터를 호출된 인덱스에 맞게 새로 저장
- 의존성 변경시 콜백함수를 업데이트
- 컴포넌트 제거시 ref가 삭제되며 메모리 정리

## 구현 중점
- 파라미터가 고정된 함수를 만들때 파라미터를 받아서 바로 실행하고 파라미터를 버리는 것이 아니므로 파라미터를 저장해야 함
- 컴포넌트 메모이제이션을 위해 같은 파라미터는 같은 함수를 제공해야 하고 이를 참조의 방식으로 구현

## 구현 방식
두 가지 방식의 장단점이 존재하는데 메모리가 초기화 되지 않는 상황이 발생하는 경우 메모리 누수가 발생하고 사용되는 메모리가 계속 증가하게 됨. 이는 WeakMap을 사용해서 어느정도 해결이 가능하지만, 새로운 함수를 계속 생성하기 때문에 컴포넌트 메모이제이션이 작동하지 않게 됨.

1. 매개변수와 매개변수를 사용하는 함수 매핑
    - 장점: 같은 매개변수를 사용하는 함수는 같은 결과를 갖게 되니 캐시가 가능
    - 단점: 한개 이상의 파라미터 사용시 비교 시간이 늘어남
    - 단점: 동적인 파라미터가 무한개 입력되는 상황인 경우 메모리가 초기화되지 않고 계속 쌓일 수 있음 (WeakMap으로 해결 가능)
2. **호출 순서와 매개변수를 사용하는 함수 매핑 (현재 구현방식)**
    - 장점: 매개변수 비교 없이 호출 순서를 활용해 함수 사용 가능
    - 단점: 생성함수를 자식으로 넘기는 경우, 리렌더링 여부에 따라 호출 순서가 달라질 수 있고 메모이제이션이 불가능
    - 단점: 사용된 컴포넌트에서 리렌더링이 일어나지 않고, 생성함수를 넘겨받은 자식 컴포넌트에서 사용할 때 리렌더링이 일어나는 경우, 인덱스가 초기화되지 않아 메모리가 계속 쌓일 수 있음 (WeakMap으로 해결 가능)